# IaC（Infrastructure as Code）ファイルから非機能要件レベルを推定するためのパターン定義
# assess.cjs の IaC 分析機能で使用

patterns:
  # サーバ冗長化
  - id: A.2.1.1
    name: サーバ冗長化（レプリカ数）
    keywords:
      - replicas
      - desired_count
      - min_size
      - autoscaling
    condition:
      type: numeric_threshold
      pattern: "(replicas|desired_count|min_size)\\s*[:=]\\s*(\\d+)"
      thresholds:
        - min: 2
          level: "2"  # 冗長構成

  # サーバ冗長化（Multi-AZ）
  - id: A.2.1.1
    name: サーバ冗長化（Multi-AZ）
    keywords:
      - multi_az
      - availability_zones
    condition:
      type: boolean_match
      patterns:
        - "multi_az.*true"
        - "availability_zones.*\\[.*,.*\\]"
      level: "2"  # 冗長構成

  # バックアップ保持期間
  - id: C.1.2.6
    name: バックアップ保持期間
    keywords:
      - retention_period
      - retention_days
      - backup_retention
    condition:
      type: numeric_threshold
      pattern: "(retention_period|retention_days|backup_retention)\\s*[:=]\\s*(\\d+)"
      thresholds:
        - min: 3650
          level: "4"  # 10年以上
        - min: 1825
          level: "3"  # 5年以上
        - min: 1095
          level: "2"  # 3年以上
        - min: 365
          level: "1"  # 1年以上
        - min: 0
          level: "0"  # 1年未満

  # ストレージ暗号化
  - id: E.6.1.2
    name: ストレージ暗号化
    keywords:
      - encrypted
      - kms_key_id
      - sse_algorithm
      - encryption_at_rest
    condition:
      type: keyword_presence
      patterns:
        - "encrypted.*true"
        - "kms_key"
        - "sse_algorithm"
        - "encryption_at_rest"
      level: "2"  # 暗号化あり

  # 監視設定
  - id: C.1.3.1
    name: 監視設定
    keywords:
      - cloudwatch
      - datadog
      - newrelic
      - prometheus
      - grafana
      - alert
      - alarm
    condition:
      type: keyword_presence
      patterns:
        - "alert"
        - "alarm"
      level_if_match: "2"    # アラート設定あり
      level_if_no_match: "1" # 監視ツールのみ

  # ロードバランサ
  - id: A.2.1.2
    name: 負荷分散
    keywords:
      - load_balancer
      - alb
      - nlb
      - elb
      - ingress
    condition:
      type: keyword_presence
      patterns:
        - "load_balancer"
        - "aws_lb"
        - "aws_alb"
        - "kubernetes_ingress"
      level: "2"  # 負荷分散あり

  # 自動スケーリング
  - id: B.1.2.1
    name: 自動スケーリング
    keywords:
      - autoscaling
      - auto_scaling
      - horizontal_pod_autoscaler
      - hpa
    condition:
      type: keyword_presence
      patterns:
        - "autoscaling"
        - "auto_scaling"
        - "horizontal_pod_autoscaler"
      level: "3"  # 自動スケーリング対応

# 対応するIaCファイル拡張子
supported_files:
  - "*.tf"
  - "*.yaml"
  - "*.yml"
  - "Dockerfile"
  - "docker-compose*.yml"
  - "*.json"  # AWS CloudFormation

# 除外ディレクトリ
exclude_dirs:
  - node_modules
  - .git
  - .terraform
  - vendor
